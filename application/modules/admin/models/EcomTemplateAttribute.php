<?php

/**
 * Admin_Model_EcomTemplateAttribute
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage RhemaSys
 * @author     Pele Odiase <info@rhema-webesign.com>
 * @version    SVN: $Id: Builder.php 6716 2009-11-12 19:26:28Z jwage $
 */
class Admin_Model_EcomTemplateAttribute extends Admin_Model_Base_EcomTemplateAttribute {
	
	public static function getAttributes($templateId = null, $displayType = 1){ 
		$templateId 	= $templateId ? $templateId : 
							Admin_Model_EcomDisplayTemplate::getDefaultTemplate($displayType);
		$model = __CLASS__ ;
		$query = Doctrine_Query::create()
					->select('c.ecom_attribute_id,c.sequence,c.label,g.*')
					->where("c.ecom_display_template_id =?", $templateId)
					->from("$model c INDEXBY c.id")
					->orderBy('c.sequence')
					->leftJoin('c.EcomAttribute g')
					->setHydrationMode(Doctrine_Core::HYDRATE_ARRAY);
		return $query->execute();					
	}
	
	public static function updateAttributes($templateId, $attributes = array(), $labels = array()){ 
		$model     		= __CLASS__ ; 				
		$attributes  	= array_flip($attributes);		
		$dateTime  		= date(DB_DATE_FORMAT, time()); 
		
		$query  = Doctrine_Query::create()
					->from("$model p")
					->where("p.ecom_display_template_id =?", $templateId) 
					->andWhere('p.deleted_at IS NULL OR p.deleted_at IS NOT NULL');
		$layout = $query->execute();
		
		foreach($layout as $index => $row){
			$attrId = intVal($row['ecom_attribute_id']);
			if(isset($attributes[$attrId])){ 
				$row['deleted_at'] = null;
				$row['sequence']   = $attributes[$attrId];
				$row['label']      = isset($labels[$attrId]) ? $labels[$attrId] : '';
				unset($attributes[$attrId]); 
			}else{
				$row['deleted_at'] = $dateTime;
			}					
		}
		
		$layout->save();
		
		
		if(count($attributes)){   	    					    			 	  
		 	foreach($attributes as $id => $seq){	 
	 			$obj = new $model();
		 		$obj->ecom_attribute_id 		= $id;			 		
		 		$obj->ecom_display_template_id  = $templateId;
		 		$obj->sequence    				= $seq; 
		 		$obj->label						= isset($labels[$attrId]) ? $labels[$attrId] : '';
		 		$obj->save(); 	
		 	}	    			 		    				
		}
	}
}